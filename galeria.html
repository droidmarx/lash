<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galeria CRUD - Cloudinary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .galeria {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }
    .card {
      transform: translateY(20px);
      opacity: 0;
      animation: fadeInUp 0.5s ease-out forwards;
      position: relative;
    }
    @keyframes fadeInUp {
      to { transform: translateY(0); opacity: 1; }
    }
    .image-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #db2777;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-100 to-pink-200 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">

  <h1 class="text-xl sm:text-2xl font-bold text-center text-pink-600 mb-4 sm:mb-6 flex items-center justify-center gap-2">
    <i data-lucide="image" class="w-6 h-6 sm:w-7 sm:h-7"></i> Galeria I Lash
  </h1>

  <div class="w-full max-w-md bg-white p-4 sm:p-6 rounded-2xl shadow-lg mb-4 sm:mb-6">
    <div class="flex flex-col gap-4">
      <input type="file" id="fileInput" class="w-full border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:ring-2 focus:ring-pink-400 outline-none">
      <input type="text" id="tituloInput" placeholder="Título da imagem" class="w-full border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:ring-2 focus:ring-pink-400 outline-none">
      <button onclick="uploadImagem()" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition text-sm sm:text-base">
        Adicionar Imagem
      </button>
    </div>
  </div>

  <button id="btnAtualizar" onclick="atualizarGaleria()" class="bg-pink-500 hover:bg-pink-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition text-sm sm:text-base mb-4 sm:mb-6">
    Atualizar Galeria
  </button>

 <div class="w-full max-w-4xl relative">
  <div class="loading-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]" id="galeriaLoading">
    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg max-w-sm w-full text-center">
      <img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" 
           alt="Nuvem flutuante" 
           class="w-12 mx-auto mb-4 animate-[floatCloud_2s_ease-in-out_infinite]">
      <p class="text-sm text-gray-600 font-medium">Carregando galeria...</p>
    </div>
  </div>
</div>
    <div class="galeria" id="galeria"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const CLOUDINARY_CLOUD_NAME = 'dhivkajaz';
    const CLOUDINARY_UPLOAD_PRESET = 'Lashtayna';
    const CLOUDINARY_API_KEY = '733889859655914';
    const CLOUDINARY_API_SECRET = 'B02rMMVo_doXMzK7nzbg3qNRXsc';
    const MOCKAPI_URL = 'https://683d14e6199a0039e9e427bd.mockapi.io/imagens';

    const galeriaLoading = document.getElementById('galeriaLoading');

    async function atualizarGaleria() {
      galeriaLoading.classList.remove('hidden');
      try {
        const res = await fetch(MOCKAPI_URL);
        const imagens = await res.json();
        const galeria = document.getElementById('galeria');
        galeria.innerHTML = "";

        imagens.forEach((img, index) => {
          const div = document.createElement('div');
          div.className = 'card bg-white rounded-xl shadow-md overflow-hidden';
          div.style.animationDelay = `${index * 0.1}s`;
          div.innerHTML = `
            <div class="image-loading" id="loading-${img.id}">
              <div class="spinner"></div>
            </div>
            <img src="${img.url}" alt="${img.titulo}" class="w-full h-40 sm:h-48 object-cover hover:scale-105 transition-transform duration-300" onload="document.getElementById('loading-${img.id}').style.display='none'">
            <p class="p-3 text-sm sm:text-base font-medium text-gray-800 text-center">${img.titulo}</p>
            <div class="absolute top-2 right-2 flex gap-2">
              <button class="edit bg-pink-500 hover:bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition" onclick="editarImagem('${img.id}', '${img.titulo}')">
                <i data-lucide="edit" class="w-4 h-4"></i>
              </button>
              <button class="delete bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition" onclick="deletarImagem('${img.id}', '${img.public_id}')">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          `;
          galeria.appendChild(div);
        });
        lucide.createIcons();
      } catch (err) {
        console.error(err);
        alert("Erro ao carregar a galeria");
      } finally {
        galeriaLoading.classList.add('hidden');
      }
    }

    async function uploadImagem() {
      const file = document.getElementById('fileInput').files[0];
      const titulo = document.getElementById('tituloInput').value;
      if (!file || !titulo) {
        alert("Selecione uma imagem e insira um título!");
        return;
      }

      galeriaLoading.classList.remove('hidden');

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`);
      xhr.onload = async () => {
        const data = JSON.parse(xhr.responseText);
        if (!data.secure_url) {
          alert("Upload falhou");
          galeriaLoading.classList.add('hidden');
          return;
        }

        await fetch(MOCKAPI_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ titulo: titulo, url: data.secure_url, public_id: data.public_id })
        });

        document.getElementById('fileInput').value = "";
        document.getElementById('tituloInput').value = "";
        setTimeout(atualizarGaleria, 500);
      };
      xhr.onerror = () => {
        alert("Erro ao enviar a imagem.");
        galeriaLoading.classList.add('hidden');
      };
      xhr.send(formData);
    }

    async function deletarImagem(id, public_id) {
      if (!confirm("Deseja realmente excluir esta imagem?")) return;

      galeriaLoading.classList.remove('hidden');

      try {
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/destroy`;
        const timestamp = Math.floor(Date.now() / 1000);
        const payload = `public_id=${public_id}&timestamp=${timestamp}${CLOUDINARY_API_SECRET}`;
        const hash = CryptoJS.SHA1(payload).toString();

        await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ public_id, timestamp, api_key: CLOUDINARY_API_KEY, signature: hash })
        });

        await fetch(`${MOCKAPI_URL}/${id}`, { method: "DELETE" });
        setTimeout(atualizarGaleria, 500);
      } catch (err) {
        console.error(err);
        alert("Erro ao deletar imagem");
        galeriaLoading.classList.add('hidden');
      }
    }

    async function editarImagem(id, tituloAtual) {
      const novoTitulo = prompt("Digite o novo título:", tituloAtual);
      if (!novoTitulo) return;

      galeriaLoading.classList.remove('hidden');

      try {
        await fetch(`${MOCKAPI_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ titulo: novoTitulo })
        });

        setTimeout(atualizarGaleria, 500);
      } catch (err) {
        console.error(err);
        alert("Erro ao atualizar título");
        galeriaLoading.classList.add('hidden');
      }
    }

    // Carrega a galeria inicialmente
    atualizarGaleria();
  </script>
</body>
</html>